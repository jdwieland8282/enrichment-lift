<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Prebid News · Enrichment Lift Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --pb-navy-900:#0b1f44; --pb-navy-800:#12305f;
      --pb-blue-600:#2f5ce5; --pb-blue-700:#274bcc; --pb-blue-100:#e9efff;
      --pb-teal-400:#27c1b9;
      --pb-gray-50:#fafbfd;  --pb-gray-100:#f2f5fa; --pb-gray-200:#e6ebf2; --pb-gray-400:#94a3b8; --pb-gray-600:#5a6b7b;
      --pb-text:#15223a; --radius:14px; --shadow:0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(11,31,68,.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --pb-orange-500:#ff8a00;
    }

          /* Chart */
      .chart-wrap{padding:18px 18px 8px}
      .chart-title{margin:0 0 4px; font-size:18px; font-weight:800}
      .chart-sub{margin:0 0 8px; font-size:12px; color:var(--pb-gray-600)}
      .legend{display:flex; gap:14px; align-items:center; font-size:12px; color:var(--pb-gray-600); margin:6px 0 0}
      .legend .dot{width:10px; height:10px; border-radius:50%}
      .legend .test{background:var(--pb-blue-600)}
      .legend .control{background:var(--pb-orange-500)}
      .chart-host{width:100%; height:260px}
      .chart-host svg{width:100%; height:100%; display:block}

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--pb-text); background:var(--pb-gray-50); font-family:var(--sans); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}

    /* Masthead */
    .masthead{background:linear-gradient(180deg,var(--pb-navy-900),var(--pb-navy-800)); color:#fff; border-bottom:1px solid rgba(255,255,255,.1);}
    .masthead .wrap{max-width:1120px; margin:0 auto; padding:18px 20px; display:flex; align-items:center; gap:16px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; text-transform:uppercase; font-size:14px;}
    .logo .mark{width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--pb-blue-600),var(--pb-teal-400)); box-shadow:0 0 0 2px rgba(255,255,255,.14) inset}
    .site-title{font-size:18px; font-weight:700}
    nav a{color:#cfe0ff; text-decoration:none; font-size:14px; padding:6px 10px; border-radius:8px;}
    nav a:hover{background-color:rgba(255,255,255,.08); color:#fff}
    .meta{margin-left:auto; font-size:12px; color:#c7d3ea}
    .controls{display:flex; gap:10px; margin-left:12px}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; font-weight:700; border-radius:10px; border:1px solid var(--pb-blue-600); background:var(--pb-blue-600); color:#fff; cursor:pointer;}
    .btn:hover{background:var(--pb-blue-700)}

    /* Page layout */
    .container{max-width:1120px; margin:24px auto; padding:0 20px}
    .grid{display:grid; grid-template-columns: minmax(0,2fr) minmax(280px,1fr); gap:22px;}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }

    /* Article / cards */
    .card{background:#fff; border:1px solid var(--pb-gray-200); border-radius:var(--radius); box-shadow:var(--shadow);}
    .section{padding:18px}
    .headline{margin:0 0 12px; font-weight:800; letter-spacing:-.015em; line-height:1.15; font-size:28px;}
    .kicker{color:var(--pb-blue-700); font-weight:700; text-transform:uppercase; letter-spacing:.08em; font-size:12px; margin-bottom:8px}
    .byline{color:var(--pb-gray-600); font-size:13px; margin-bottom:14px}
    p{line-height:1.68}
    .rule{height:1px; background:var(--pb-gray-200); margin:0}

    /* Sidebar widgets */
    .widget{background:#fff; border:1px solid var(--pb-gray-200); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .widget .hd{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--pb-gray-200); background:var(--pb-gray-100);}
    .widget .hd h3{margin:0; font-size:14px; text-transform:uppercase; letter-spacing:.08em; color:var(--pb-gray-600)}
    .metrics{padding:14px; display:grid; gap:10px}
    .metric{display:flex; align-items:baseline; justify-content:space-between; gap:10px; border:1px solid var(--pb-gray-200); border-radius:10px; padding:10px 12px;}
    .metric .label{font-size:12px; color:var(--pb-gray-600); text-transform:uppercase; letter-spacing:.06em}
    .metric .value{font-weight:800; font-size:18px}
    .muted{color:var(--pb-gray-600); font-size:12px}

    /* Ad slot */
    .ad-wrap{padding:14px}
    .ad-label{font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--pb-gray-600); margin:0 0 8px}
    #ad-slot{width:300px; height:250px; border:1px dashed var(--pb-gray-400); display:grid; place-items:center; background:var(--pb-blue-100); color:var(--pb-blue-700); border-radius:12px;}
    iframe{border:0}
  </style>
</head>

<body>
  <!-- Masthead -->
  <header class="masthead">
    <div class="wrap">
      <div class="logo"><span class="mark"></span><span class="site-title">Prebid News</span></div>
      <nav>
        <a href="#">Home</a>
        <a href="#">Ad Tech</a>
        <a href="#">Identity</a>
        <a href="#">Guides</a>
      </nav>
      <div class="meta" id="dateMeta"></div>
      <div class="controls">
        <button id="rerun" class="btn" title="Reload with a fresh run key">↻ Re-run Auction</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <div class="grid">
      <!-- Article -->
      <article class="card">
        <div class="section">
          <div class="kicker">Explainer</div>
          <h1 class="headline">Understanding the Metrics on This Page</h1>
          <div class="byline">Prebid.js · Enrichment Lift · Cohort A/B</div>

          <p><strong>auctions</strong> — Number of <code>lift_auction</code> summary events ingested for that cohort (one per auction you ran). <em>Totals.auctions = control.auctions + test.auctions.</em></p>

          <p><strong>avgTreatment</strong> — The average treatment CPM in that cohort = <em>(sum of <code>treatmentCpm</code>) / auctions</em>. In this page, this is the CPM of the ad that actually “won” (synthetic when <code>synthWinRate=1</code>, otherwise the winning path). Units: USD CPM.</p>

          <p><strong>incrementalLiftAbs</strong> — The global absolute lift per auction attributable to the test cohort: <em>incrementalLiftAbs = test.avgTreatment − control.avgTreatment</em>. Positive = test (e.g., SharedID present) is earning more per auction. Units: USD CPM.</p>

          <p><strong>incrementalLiftPct</strong> — The global relative lift: <em>incrementalLiftPct = incrementalLiftAbs / control.avgTreatment</em> (null if <code>control.avgTreatment = 0</code>). This is a fraction (e.g., <code>0.25</code> = +25%).</p>
        </div>
      </article>

      <div class="rule"></div>

        <!-- Scatter plot (above the fold) -->
        <div class="chart-wrap">
          <h2 class="chart-title">Cohort CPM Scatter</h2>
          <p class="chart-sub">Dots show auction CPM by cohort from <code>cohort-cpm.txt</code>. Lines are per-cohort linear trends.</p>
          <div id="scatter-host" class="chart-host"></div>
          <div class="legend">
            <span class="dot test"></span><span>test (Prebid blue)</span>
            <span class="dot control"></span><span>control (Prebid orange)</span>
          </div>
        </div>


      <!-- Sidebar: Metrics + Ad -->
      <aside>
        <div class="widget" style="margin-bottom:22px">
          <div class="hd"><h3>Live Metrics</h3><span class="muted" id="metricsStatus">loading…</span></div>
          <div class="metrics">
            <div class="metric"><span class="label">control.auctions</span><span class="value" id="m-ctrl-auct">—</span></div>
            <div class="metric"><span class="label">test.auctions</span><span class="value" id="m-test-auct">—</span></div>
            <div class="metric"><span class="label">control.avgTreatment</span><span class="value" id="m-ctrl-avg">—</span></div>
            <div class="metric"><span class="label">test.avgTreatment</span><span class="value" id="m-test-avg">—</span></div>
            <div class="metric"><span class="label">global.incrementalLiftAbs</span><span class="value" id="m-lift-abs">—</span></div>
            <div class="metric"><span class="label">global.incrementalLiftPct</span><span class="value" id="m-lift-pct">—</span></div>
          </div>
          <div class="section muted">Auto-refreshing from your collector’s <code>/metrics</code> endpoint.</div>
        </div>

        <div class="widget">
          <div class="hd"><h3>Sponsored</h3></div>
          <div class="ad-wrap">
            <p class="ad-label">Advertisement</p>
            <div id="ad-slot">Ad will render here</div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Scripts -->
  <script src="prebid.js" async></script>
  <script src="vendors/enrichmentLabels.js"></script>
  <script src="vendors/patchGenericLabels.js"></script>

  <script>
    // ---------- Tiny page helpers ----------
    document.getElementById('dateMeta').textContent =
      new Date().toLocaleString(undefined, { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });

    const params = new URLSearchParams(location.search);
    const collectUrl = params.get('ga') || params.get('analytics') || 'http://enrichment-lift:9090/collect';
    const synthWinRate = Math.min(1, Math.max(0, parseFloat(params.get('synthWinRate') || '1'))); // 0..1

    // Controls: make click == full reload (fresh ELM split)
    document.getElementById('rerun').addEventListener('click', function () {
      const url = new URL(location.href);
      url.searchParams.set('rk', Date.now().toString(36)); // cache-buster
      location.href = url.toString();
    });

    // ---------- Metrics fetcher (no logs) ----------
    const metricsEls = {
      ctrlAuct: document.getElementById('m-ctrl-auct'),
      testAuct: document.getElementById('m-test-auct'),
      ctrlAvg:  document.getElementById('m-ctrl-avg'),
      testAvg:  document.getElementById('m-test-avg'),
      liftAbs:  document.getElementById('m-lift-abs'),
      liftPct:  document.getElementById('m-lift-pct'),
      status:   document.getElementById('metricsStatus')
    };
    const collector = new URL(collectUrl, location.href);
    const metricsUrl = collector.origin + '/metrics';

    function fmt2(x){ return (x==null || isNaN(x)) ? '—' : (Math.round(x*100)/100).toFixed(2); }

    async function refreshMetrics(){
      try{
        metricsEls.status.textContent = 'updating…';
        const r = await fetch(metricsUrl, { cache:'no-store' });
        const j = await r.json();
        metricsEls.ctrlAuct.textContent = j?.byCohort?.control?.auctions ?? '0';
        metricsEls.testAuct.textContent = j?.byCohort?.test?.auctions ?? '0';
        metricsEls.ctrlAvg.textContent  = fmt2(j?.byCohort?.control?.avgTreatment);
        metricsEls.testAvg.textContent  = fmt2(j?.byCohort?.test?.avgTreatment);
        metricsEls.liftAbs.textContent  = fmt2(j?.global?.incrementalLiftAbs);
        metricsEls.liftPct.textContent  = (j?.global?.incrementalLiftPct == null) ? '—' : fmt2(j.global.incrementalLiftPct);
        metricsEls.status.textContent = 'live';
      }catch(e){
        metricsEls.status.textContent = 'unavailable';
      }
    }
    refreshMetrics();
    setInterval(refreshMetrics, 3000);

    // ---------- Prebid/ELM setup (v6, no console logs) ----------
    window.pbjs = window.pbjs || {}; pbjs.que = pbjs.que || [];

    pbjs.que.push(function () {
      function round2(x){ return Math.round((Number(x) + Number.EPSILON) * 100) / 100; }
      function getLabels(){ return (window.pbjs && window.pbjs._analyticsLabels) || {}; }
      function inferCohort(labels){
        try {
          return Object.values(labels).some(arr =>
            Array.isArray(arr) && arr.some(m => m && m.enabled === true)
          ) ? 'test' : 'control';
        } catch { return 'control'; }
      }
      function postSummary(baselineCpm, treatmentCpm, winnerSource) {
        const labels = getLabels();
        const cohort = inferCohort(labels);
        const payload = {
          type: 'lift_auction',
          cohort,
          baselineCpm: round2(baselineCpm),
          treatmentCpm: round2(treatmentCpm),
          incrementalCpm: round2(Number(treatmentCpm) - Number(baselineCpm)),
          winner: winnerSource,
          labels
        };
        try {
          const json = JSON.stringify(payload);
          const cross = new URL(collectUrl, location.href).origin !== location.origin;
          if (!cross && navigator.sendBeacon) {
            navigator.sendBeacon(collectUrl, json);
          } else {
            fetch(collectUrl, { method: 'POST', mode: 'cors', credentials: 'omit', body: json });
          }
        } catch(e) {}
      }

      // Config (keep v6 behavior)
      const freshRun = `DemoRun-${performance.now().toFixed(0)}-${Math.random().toString(36).slice(2,6)}`;
      pbjs.setConfig({
        bidderTimeout: 1200,
        userSync: {
          syncDelay: 0,
          userIds: [{ name: 'sharedId', storage: { type: 'cookie', name: '_sharedid', expires: 365 } }]
        },
        enrichmentLiftMeasurement: {
          testRun: freshRun,
          storeSplits: 'memory',
          suppression: 'submodules',
          modules: [{ name: 'sharedId', percentage: 0.5 }]
        }
      });

      // Generic Analytics adapter
      pbjs.enableAnalytics({
        provider: 'generic',
        options: {
          url: collectUrl,
          batchSize: 5,
          batchDelay: 200,
          events: {
            auctionInit(args)   { return { eventType:'auctionInit',  labels: __computeEnrichmentLabels(), args }; },
            bidRequested(args)  { return { eventType:'bidRequested', labels: __computeEnrichmentLabels(), args }; },
            bidResponse(args)   { return { eventType:'bidResponse',  labels: __computeEnrichmentLabels(), args }; },
            auctionEnd(args)    { return { eventType:'auctionEnd',   labels: __computeEnrichmentLabels(), args }; },
            bidWon(args)        { return { eventType:'bidWon',       labels: __computeEnrichmentLabels(), args }; },
            noBid(args)         { return { eventType:'noBid',        labels: __computeEnrichmentLabels(), args }; },
            bidTimeout(args)    { return { eventType:'bidTimeout',   labels: __computeEnrichmentLabels(), args }; }
          }
        }
      });

      // One banner unit
      const adUnits = [{
        code: 'hb-direct-slot',
        mediaTypes: { banner: { sizes: [[300, 250]] } },
        bids: [{ bidder: 'appnexus', params: { placementId: '13144370' } }]
      }];

      // Creative rotation persisted across reloads
      const creatives = ['ads/peanutbutter.jpeg','ads/images.jpeg','ads/download.jpeg'];
      const CREATIVE_IDX_KEY = 'elmCreativeIdx';
      function nextCreative() {
        const n = creatives.length;
        let i = parseInt(sessionStorage.getItem(CREATIVE_IDX_KEY) || '0', 10);
        if (!Number.isFinite(i) || i < 0) i = 0;
        const pick = creatives[i % n];
        sessionStorage.setItem(CREATIVE_IDX_KEY, (i + 1) % n);
        return pick;
      }

      function renderSynthetic({ cpm, creative }) {
        const slot = document.getElementById('ad-slot');
        const isImg = /\.(png|jpe?g|gif|webp|svg)$/i.test(creative);
        slot.innerHTML = '';
        if (isImg) {
          const img = new Image(); img.width = 300; img.height = 250; img.src = creative; slot.appendChild(img);
        } else {
          slot.innerHTML = `<iframe src="${creative}" width="300" height="250" frameborder="0" scrolling="no"></iframe>`;
        }
      }

      function renderPrebid(winning) {
        const iframe = document.createElement('iframe');
        iframe.width = 300; iframe.height = 250; iframe.frameBorder = 0; iframe.scrolling = 'no';
        const slot = document.getElementById('ad-slot'); slot.innerHTML = ''; slot.appendChild(iframe);
        try { pbjs.renderAd(iframe.contentDocument, winning.adId); } catch (e) {}
      }

      function runAuction() {
        document.getElementById('ad-slot').textContent = 'Loading…';

        // Add units once, then request bids
        pbjs.addAdUnits(adUnits);

        pbjs.requestBids({
          adUnits,
          bidsBackHandler: function () {
            const top = pbjs.getHighestCpmBids('hb-direct-slot') || [];
            const pb = top[0];
            const pbCpm = pb ? Number(pb.cpm) : 0;

            // Synthetic bid, lift and winner
            const labels = (window.pbjs && window.pbjs._analyticsLabels) || {};
            const isTest = Object.values(labels).some(arr => Array.isArray(arr) && arr.some(m => m && m.enabled === true));
            let synthCpm = Math.random() * 2 + 1;
            const synthLift = parseFloat((new URLSearchParams(location.search)).get('synthLift') || '0.5');
            if (isTest) synthCpm += synthLift;
            const synthCreative = nextCreative();

            const coin = Math.random();
            if (!pb || coin < synthWinRate) {
              renderSynthetic({ cpm: Math.round(synthCpm*100)/100, creative: synthCreative });
              postSummary(pbCpm, synthCpm, 'synthetic');
            } else {
              renderPrebid(pb);
              postSummary(pbCpm, pbCpm, 'prebid');
            }
          },
          timeout: 800
        });
      }

      // First run
      runAuction();
    });
  </script>
  <script>
    (function(){
      const host = document.getElementById('scatter-host');
      if (!host) return;

      // Tolerant parser for cohort-cpm.txt
      // Accepts lines like:
      //   control,2.45
      //   test, 3.10
      //   2025-10-08T12:00Z,test,2.90
      //   {"cohort":"control","cpm":2.2}
      //   cohort,cpm   (header)
      function parseCohortText(txt){
        const out = [];
        const lines = txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        if (!lines.length) return out;

        // header?
        let start = 0;
        const first = lines[0].toLowerCase();
        if (first.includes('cohort') && first.includes('cpm')) start = 1;

        for (let i=start; i<lines.length; i++){
          const line = lines[i];
          let rec = null;

          // JSON line?
          if (line.startsWith('{') || line.startsWith('[')){
            try {
              const obj = JSON.parse(line);
              if (Array.isArray(obj)){
                obj.forEach(o => {
                  if (o && (o.cohort || o.segment) && (o.cpm != null)) {
                    out.push({ cohort: String(o.cohort || o.segment).toLowerCase(), cpm: Number(o.cpm) });
                  }
                });
                continue;
              } else if (obj && (obj.cohort || obj.segment) && (obj.cpm != null)){
                rec = { cohort: String(obj.cohort || obj.segment).toLowerCase(), cpm: Number(obj.cpm) };
              }
            } catch(_) {}
          }

          if (!rec){
            const parts = line.split(/[\t,]/).map(s => s.trim()).filter(Boolean);
            if (parts.length >= 3){
              // time, cohort, cpm  OR  cohort, cpm, extra
              const a = parts[0].toLowerCase();
              const b = parts[1];
              const c = parts[2];
              if (a === 'cohort'){
                rec = { cohort: String(b).toLowerCase(), cpm: Number(c) };
              } else {
                const maybeCoh = /^(test|control)$/i.test(b) ? b : parts[0];
                const maybeCpm = parts.find(p => /^\d+(?:\.\d+)?$/.test(p));
                if (maybeCpm != null){
                  rec = { cohort: String(maybeCoh).toLowerCase(), cpm: Number(maybeCpm) };
                }
              }
            } else if (parts.length === 2){
              rec = { cohort: String(parts[0]).toLowerCase(), cpm: Number(parts[1]) };
            }
          }

          if (rec && Number.isFinite(rec.cpm) && (rec.cohort === 'test' || rec.cohort === 'control')) {
            out.push(rec);
          }
        }
        return out;
      }

      function regression(points){
        const n = points.length;
        if (!n) return { a:0, b:0, valid:false };
        let sx=0, sy=0, sxx=0, sxy=0;
        for (const p of points){ sx+=p.x; sy+=p.y; sxx+=p.x*p.x; sxy+=p.x*p.y; }
        const denom = (n*sxx - sx*sx);
        if (denom === 0){ return { a: sy/n, b: 0, valid: true }; } // horizontal at mean
        const b = (n*sxy - sx*sy) / denom;
        const a = (sy - b*sx) / n;
        return { a, b, valid: true };
      }

      function draw(data){
        host.innerHTML = '';
        const W = host.clientWidth || 700;
        const H = host.clientHeight || 260;
        const pad = { l:46, r:18, t:10, b:28 };

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
        svg.setAttribute('role', 'img');
        host.appendChild(svg);

        const by = { test: [], control: [] };
        let i = 0;
        for (const d of data){ by[d.cohort].push({ x: i, y: d.cpm }); i++; }

        const N = data.length;
        const maxX = Math.max(1, N - 1);
        const maxY = Math.max(1, Math.ceil(Math.max(...data.map(d => d.cpm)) * 2) / 2);

        const x = v => pad.l + ((W - pad.l - pad.r) * (v / maxX));
        const y = v => H - pad.b - ((H - pad.t - pad.b) * (v / maxY));

        // Axes + grid
        const axis = document.createElementNS(svg.namespaceURI, 'g');
        axis.setAttribute('fill', 'none');
        axis.setAttribute('stroke', '#cbd5e1');
        axis.setAttribute('stroke-width', '1');
        svg.appendChild(axis);

        const xline = document.createElementNS(svg.namespaceURI, 'line');
        xline.setAttribute('x1', pad.l); xline.setAttribute('x2', W - pad.r);
        xline.setAttribute('y1', H - pad.b); xline.setAttribute('y2', H - pad.b);
        axis.appendChild(xline);

        const yline = document.createElementNS(svg.namespaceURI, 'line');
        yline.setAttribute('x1', pad.l); yline.setAttribute('x2', pad.l);
        yline.setAttribute('y1', pad.t); yline.setAttribute('y2', H - pad.b);
        axis.appendChild(yline);

        const yticks = 5;
        for (let t = 0; t <= yticks; t++){
          const v = maxY * (t/yticks);
          const yy = y(v);
          const tl = document.createElementNS(svg.namespaceURI, 'line');
          tl.setAttribute('x1', pad.l - 4); tl.setAttribute('x2', pad.l);
          tl.setAttribute('y1', yy); tl.setAttribute('y2', yy);
          tl.setAttribute('stroke', '#94a3b8');
          axis.appendChild(tl);

          const tx = document.createElementNS(svg.namespaceURI, 'text');
          tx.setAttribute('x', pad.l - 8);
          tx.setAttribute('y', yy + 4);
          tx.setAttribute('text-anchor', 'end');
          tx.setAttribute('font-size', '11');
          tx.setAttribute('fill', '#64748b');
          tx.textContent = (Math.round(v*100)/100).toFixed(2);
          svg.appendChild(tx);

          const gl = document.createElementNS(svg.namespaceURI, 'line');
          gl.setAttribute('x1', pad.l); gl.setAttribute('x2', W - pad.r);
          gl.setAttribute('y1', yy); gl.setAttribute('y2', yy);
          gl.setAttribute('stroke', '#e2e8f0');
          gl.setAttribute('stroke-dasharray', '3 4');
          svg.appendChild(gl);
        }

        // Colors
        const CSS = getComputedStyle(document.documentElement);
        const C_TEST = (CSS.getPropertyValue('--pb-blue-600') || '#2f5ce5').trim();
        const C_CTRL = (CSS.getPropertyValue('--pb-orange-500') || '#ff8a00').trim();

        // Dots
        function dots(arr, color){
          for (const p of arr){
            const c = document.createElementNS(svg.namespaceURI, 'circle');
            c.setAttribute('cx', x(p.x));
            c.setAttribute('cy', y(p.y));
            c.setAttribute('r', '3.5');
            c.setAttribute('fill', color);
            c.setAttribute('fill-opacity', '0.9');
            c.setAttribute('stroke', 'white');
            c.setAttribute('stroke-width', '0.8');
            svg.appendChild(c);
          }
        }
        dots(by.control, C_CTRL);
        dots(by.test, C_TEST);

        // Trend lines
        function trend(arr, color){
          if (!arr.length) return;
          const r = regression(arr);
          const x0 = 0, x1 = maxX;
          let y0 = r.a + r.b * x0;
          let y1 = r.a + r.b * x1;
          y0 = Math.max(0, Math.min(maxY, y0));
          y1 = Math.max(0, Math.min(maxY, y1));
          const path = document.createElementNS(svg.namespaceURI, 'path');
          path.setAttribute('d', `M ${x(x0)} ${y(y0)} L ${x(x1)} ${y(y1)}`);
          path.setAttribute('stroke', color);
          path.setAttribute('stroke-width', '2.5');
          path.setAttribute('fill', 'none');
          svg.appendChild(path);
        }
        trend(by.control, C_CTRL);
        trend(by.test, C_TEST);
      }

      async function loadAndDraw(){
        try{
          const res = await fetch('cohort-cpm.txt', { cache:'no-store' });
          if (!res.ok) throw new Error('not ok');
          const txt = await res.text();
          const rows = parseCohortText(txt);
          if (!rows.length){
            host.textContent = 'No points found in cohort-cpm.txt';
            return;
          }
          draw(rows);
          window.addEventListener('resize', () => draw(rows));
        } catch(e){
          host.textContent = 'cohort-cpm.txt not found or unreadable';
        }
      }
      loadAndDraw();
    })();
  </script>  
</body>
</html>
