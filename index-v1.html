<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prebid Auction Demo — Random Bids + Generic Analytics</title>
  <style>
    :root { --line:#dcdde1; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    .wrap { max-width: 1100px; margin: auto; }
    header { margin-bottom: 1.25rem; }
    code { background: #f5f5f7; padding: .1rem .35rem; border-radius: .25rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
    .panel { border: 1px solid var(--line); border-radius: 12px; padding: 16px; }
    .slot { width: 300px; height: 250px; display: flex; align-items: center; justify-content: center; border: 1px dashed #bbb; position: relative;}
    .note { color: var(--muted); font-size: .95rem; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0b1020; color:#d6e0ff; padding:12px; border-radius: 10px; max-height: 240px; overflow:auto; }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; }
    .pill { font-size: 11px; padding: 2px 8px; border:1px solid var(--line); border-radius: 999px; display:inline-block; }
    .win { background:#e7f9ef; border:1px solid #10b98140; color:#065f46; }
    .lose { background:#f8f0f2; border:1px solid #ef444440; color:#7f1d1d; }
    .flex { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    footer { margin-top: 24px; color: var(--muted); }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--line); background: white; cursor: pointer; }
    button:active { transform: translateY(1px); }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Prebid Auction Demo</h1>
    <p class="note">
      • Left: <strong>GPT sample slot</strong> with <em>safe fallback</em>.<br>
      • Right: <strong>Prebid direct-render slot</strong> plus a <em>client-side synthetic bidder</em> that generates random bids. The higher CPM between Prebid and the synthetic bidder wins and is rendered.
    </p>
  </header>

  <div class="grid">
    <section class="panel">
      <div class="flex">
        <h3>GPT path (with fallback)</h3>
        <button id="rerunBtn1">Re-run</button>
      </div>
      <div id="ad-slot-1" class="slot" aria-label="GPT 300x250 slot">
        <em>300×250 (GPT will display; fallback if empty)</em>
      </div>
      <p class="note">Uses Google's public sample ad unit. If it serves nothing, we inject a local fallback creative.</p>
    </section>

    <section class="panel">
      <div class="flex">
        <h3>Prebid direct render + Random bidder</h3>
        <button id="rerunBtn2">Re-run</button>
      </div>
      <div id="hb-direct-slot" class="slot" aria-label="Prebid 300x250 slot">
        <em>300×250 (Prebid + Synthetic)</em>
      </div>
      <div style="margin-top:12px;">
        <div class="kv">
          <div>Prebid winner CPM:</div><div id="prebidCpm">–</div>
          <div>Synthetic bidder CPM:</div><div id="synthCpm">–</div>
          <div>Rendered by:</div><div id="renderedBy">–</div>
        </div>
      </div>
      <details style="margin-top:12px;">
        <summary>Analytics stream</summary>
        <div id="log" class="log" role="log" aria-live="polite"></div>
      </details>
      <p class="note">Tip: add <code>?synthMax=3.5&amp;synthWinRate=0.7</code> to the URL to tweak the synthetic bidder.</p>
    </section>
  </div>

  <!-- 1) GLOBAL FALLBACK & FLAG (define before GPT/Prebid) -->
  <script>
  // Only flip true when a *real* creative renders (GPT non-empty or fallback)
  var creativeRendered = false;

  // Safe fallback creative (srcdoc in a same-origin iframe)
  function renderFallbackCreative() {
    if (creativeRendered) return;
    var slot = document.getElementById('ad-slot-1');
    if (!slot) return;

    var html = `<!doctype html><html><head><meta charset="utf-8"><style>
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0;background:#1f3a93;color:#fff;font-family:Inter,system-ui,Arial}
      .wrap{width:300px;height:250px;display:grid;place-items:center}
      .card{width:280px;height:220px;border-radius:14px;padding:14px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25)}
      .h{font-weight:900;font-size:22px;margin:6px 0}
      .p{font-size:12px;opacity:.9}
      .cta{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.6);text-decoration:none;color:inherit}
    </style></head><body>
      <div class="wrap"><div class="card">
        <div class="h">Sample 300×250</div>
        <div class="p">Guaranteed demo creative</div>
        <a class="cta" href="https://example.com/?src=fallback" target="_blank" rel="noopener">Learn more →</a>
      </div></div>
    </body></html>`;

    // Replace whatever GPT left there (could be an empty cross-origin iframe)
    slot.innerHTML = '';
    var iframe = document.createElement('iframe');
    iframe.width = 300;
    iframe.height = 250;
    iframe.setAttribute('data-rendered','fallback');
    iframe.setAttribute(
      'sandbox',
      'allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-scripts allow-top-navigation-by-user-activation'
    );
    iframe.srcdoc = html; // reliable paint without document.write
    slot.appendChild(iframe);
    creativeRendered = true;
  }
  </script>

  <!-- 2) Load Prebid.js (your local build should include appnexusBidAdapter)  -->
  <!-- <script src="prebid.js" async></script> -->
  <script src="https://cdn.jsdelivr.net/npm/prebid.js@latest/dist/not-for-prod/prebid.js"></script>

  <!-- 3) Load GPT -->
  <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>

  <!-- 4) GPT setup (uses public sample unit) -->
  <script>
  window.googletag = window.googletag || { cmd: [] };
  googletag.cmd.push(function () {
    var slot = googletag.defineSlot('/6355419/Travel/Europe/France/Paris', [300, 250], 'ad-slot-1')
      .addService(googletag.pubads());
    googletag.pubads().disableInitialLoad();
    googletag.enableServices();

    // Mark success ONLY if GPT really rendered something non-empty
    googletag.pubads().addEventListener('slotRenderEnded', function (e) {
      if (e.slot === slot && !e.isEmpty) {
        creativeRendered = true;
        var ifr = document.querySelector('#ad-slot-1 iframe');
        if (ifr) ifr.setAttribute('data-rendered','gpt');
        analytics('gpt_render', { slot: 'ad-slot-1', isEmpty: false });
      }
    });
  });
  </script>

  <!-- 5) Generic analytics shim (listen to Prebid events + manual events) -->
  <script>
    // Set to a URL (or pass ?analytics=<url>) to send beacons there. If falsy, logs only.
    const params = new URLSearchParams(location.search);
    const ANALYTICS_ENDPOINT = params.get('analytics') || '';

    function analytics(event, payload) {
      const logEl = document.getElementById('log');
      const line = { ts: new Date().toISOString(), event, payload };
      if (logEl) {
        logEl.textContent += JSON.stringify(line) + "\n";
        logEl.scrollTop = logEl.scrollHeight;
      }
      // Console for devs
      console.info('[analytics]', event, payload);

      // Optional POST
      if (ANALYTICS_ENDPOINT) {
        try {
          const body = new Blob([JSON.stringify(line)], { type: 'application/json' });
          // Prefer sendBeacon; fall back to fetch
          if (!navigator.sendBeacon || !navigator.sendBeacon(ANALYTICS_ENDPOINT, body)) {
            fetch(ANALYTICS_ENDPOINT, { method: 'POST', mode: 'no-cors', body });
          }
        } catch (e) {
          console.warn('analytics send failed', e);
        }
      }
    }
  </script>

  <!-- 6) Prebid config + Direct Render path (no GPT on hb-direct-slot) + Synthetic bidder -->
  <script>
  window.pbjs = window.pbjs || {}; pbjs.que = pbjs.que || [];

  // Synthetic bidder configuration (URL params let you tune behavior)
  const synthMax = parseFloat(params.get('synthMax') || '3.50'); // max CPM
  const synthWinRate = Math.max(0, Math.min(1, parseFloat(params.get('synthWinRate') || '0.6'))); // chance that a bid is present
  const synthCurrency = params.get('synthCur') || 'USD';

  function syntheticBid() {
    const hasBid = Math.random() < synthWinRate; // e.g., 60% of the time returns a bid
    if (!hasBid) {
      analytics('synthetic_nobid', {});
      return null;
    }
    const cpm = +(Math.random() * synthMax).toFixed(2);
    const adHtml = `<!doctype html><html><head><meta charset="utf-8"><style>
      html,body{height:100%}body{margin:0;display:grid;place-items:center;background:#0f172a;color:#e2e8f0;font-family:Inter,system-ui,Arial}
      .card{width:280px;height:220px;border-radius:14px;padding:14px;background:linear-gradient(135deg, #111827, #1f2937);border:1px solid #334155}
      .h{font-weight:900;font-size:22px;margin:6px 0}
      .p{font-size:12px;opacity:.85}
      .cpm{margin-top:8px;font-weight:700}
      .cta{display:inline-block;margin-top:10px;padding:8px 12px;border-radius:10px;border:1px solid #94a3b8;text-decoration:none;color:inherit}
    </style></head><body>
      <div class="card">
        <div class="h">Synthetic Bidder</div>
        <div class="p">Client-side demo creative</div>
        <div class="cpm">CPM: ${cpm.toFixed(2)} ${synthCurrency}</div>
        <a class="cta" href="https://example.com/?src=synthetic" target="_blank" rel="noopener">Learn more →</a>
      </div>
    </body></html>`;
    const b = { bidder: 'synthetic', cpm, currency: synthCurrency, ad: adHtml, width: 300, height: 250 };
    analytics('synthetic_bid', { cpm });
    return b;
  }

  function runAuctions() {
    // Reset UI
    document.getElementById('prebidCpm').textContent = '–';
    document.getElementById('synthCpm').textContent = '–';
    document.getElementById('renderedBy').textContent = '–';
    document.getElementById('hb-direct-slot').innerHTML = '<em>300×250 (Prebid + Synthetic)</em>';

    // Ask Prebid to do its thing
    pbjs.que.push(function () {
      analytics('prebid_init', {});

      // Minimal config
      pbjs.setConfig({
        bidderTimeout: 1200,
        userSync: { syncDelay: 0 }
      });

      // IMPORTANT: The ad unit code matches the direct-render div (hb-direct-slot)
      const adUnits = [{
        code: 'hb-direct-slot',
        mediaTypes: { banner: { sizes: [[300, 250]] } },
        bids: [{
          bidder: 'appnexus',
          params: { placementId: 13144370 }, // public test placement
          getFloor: () => ({ currency: 'USD', floor: 0.50 })
        }]
      }];

      pbjs.removeAdUnit && pbjs.removeAdUnit('hb-direct-slot');
      pbjs.addAdUnits(adUnits);

      // Listen to some Prebid events
      ['auctionInit','auctionEnd','bidResponse','bidWon','bidTimeout','noBid'].forEach(function(evt){
        pbjs.onEvent(evt, function(data){ analytics('prebid_' + evt, data); });
      });

      pbjs.requestBids({
        adUnits,
        timeout: 1200,
        bidsBackHandler: function () {
          // Prebid winner (may be empty)
          var prebidWinners = pbjs.getHighestCpmBids('hb-direct-slot') || [];
          var pbWin = prebidWinners[0] || null;
          var pbCpm = pbWin ? pbWin.cpm : 0;
          document.getElementById('prebidCpm').textContent = pbWin ? pbWin.cpm.toFixed(2) + ' ' + (pbWin.currency || 'USD') : '—';

          // Our synthetic bidder
          var synth = syntheticBid();
          var synthCpm = synth ? synth.cpm : 0;
          document.getElementById('synthCpm').textContent = synth ? synth.cpm.toFixed(2) + ' ' + synth.currency : '—';

          // Decide the winner
          var winner = null;
          if (synthCpm > pbCpm) {
            winner = { source: 'synthetic', bid: synth };
          } else if (pbWin) {
            winner = { source: 'prebid', bid: pbWin };
          } else {
            winner = null;
          }

          var slot = document.getElementById('hb-direct-slot');
          var iframe = document.createElement('iframe');
          iframe.width = 300; iframe.height = 250; iframe.frameBorder = 0;
          slot.innerHTML = ''; slot.appendChild(iframe);
          var doc = iframe.contentDocument || iframe.contentWindow.document;

          if (!winner) {
            // Nothing to render – show a friendly placeholder
            doc.open(); doc.write('<!doctype html><meta charset=\"utf-8\"><div style=\"display:grid;place-items:center;height:250px;font:600 14px system-ui\">No bids</div>'); doc.close();
            analytics('render_none', {});
            document.getElementById('renderedBy').textContent = '—';
            return;
          }

          if (winner.source === 'prebid') {
            // Use Prebid's safe renderer
            try {
              pbjs.renderAd(doc, winner.bid.adId);
              analytics('render_success', { source: 'prebid', cpm: winner.bid.cpm });
              document.getElementById('renderedBy').innerHTML = '<span class="pill win">Prebid</span>';
              iframe.setAttribute('data-rendered','prebid');
            } catch (e) {
              analytics('render_error', { source: 'prebid', message: e.message });
            }
          } else {
            // Render our synthetic creative with srcdoc to keep same-origin
            iframe.setAttribute(
              'sandbox',
              'allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-scripts allow-top-navigation-by-user-activation'
            );
            iframe.srcdoc = winner.bid.ad;
            analytics('render_success', { source: 'synthetic', cpm: winner.bid.cpm });
            document.getElementById('renderedBy').innerHTML = '<span class="pill win">Synthetic</span>';
            iframe.setAttribute('data-rendered','synthetic');
          }
        }
      });
    });
  }

  // Initial Prebid + Synthetic auction
  runAuctions();
  </script>

  <!-- 7) Kick GPT display + fallback timers (uses the flag, not DOM sniffing) -->
  <script>
  function runGPT() {
    creativeRendered = false;
    document.getElementById('ad-slot-1').innerHTML = '<em>300×250 (GPT will display; fallback if empty)</em>';
    // Ask Prebid to set targeting (harmless even if we don't use it)
    pbjs.que.push(function () {
      pbjs.setTargetingForGPTAsync();
      googletag.cmd.push(function(){ googletag.display('ad-slot-1'); });
    });

    // Force a GPT display after 2s anyway (harmless if already displayed)
    setTimeout(function () {
      googletag.cmd.push(function(){ googletag.display('ad-slot-1'); });
    }, 2000);

    // If by ~3.2s nothing real rendered on the GPT slot, paint fallback
    setTimeout(function () {
      if (!creativeRendered) renderFallbackCreative();
    }, 3200);
  }

  runGPT();

  // Buttons to re-run quickly
  document.getElementById('rerunBtn1').addEventListener('click', runGPT);
  document.getElementById('rerunBtn2').addEventListener('click', runAuctions);
  </script>

  <footer>
    <p class="note">
      Analytics are captured from Prebid's event bus and from the synthetic bidder, then logged (and optionally sent via <code>navigator.sendBeacon</code> if you pass <code>?analytics=URL</code>).
    </p>
  </footer>
</div>
</body>
</html>
