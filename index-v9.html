<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --pb-blue: #00A2E1;
      --pb-dark: #0F2D3A;
      --pb-mid: #173B4C;
      --pb-text: #0B1F28;
      --pb-muted: #5F7682;
      --pb-bg: #F5FAFD;
      --pb-card: #FFFFFF;
      --pb-border: #E3EEF3;
      --radius: 14px;
      --shadow: 0 6px 18px rgba(9,44,58,.08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color: var(--pb-text);
      background: var(--pb-bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 18px 22px; background: var(--pb-card); border-bottom: 1px solid var(--pb-border);
      position: sticky; top: 0; z-index: 10;
    }
    .brand {
      display: flex; align-items: center; gap: 12px; font-weight: 700;
      color: var(--pb-dark); letter-spacing: .2px;
    }
    .brand .dot {
      width: 12px; height: 12px; border-radius: 50%; background: var(--pb-blue); display: inline-block;
    }
    .brand span { font-size: 18px; }
    .cta a, .cta button {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--pb-blue); color: #fff; border: none; border-radius: 999px;
      padding: 10px 14px; font-weight: 600; text-decoration: none; box-shadow: var(--shadow); cursor: pointer;
    }
    .wrap { max-width: 1100px; margin: 28px auto; padding: 0 20px; }
    h1 {
      font-size: 28px; margin: 0 0 10px; color: var(--pb-dark); line-height: 1.2;
    }
    .sub { color: var(--pb-muted); margin-bottom: 22px; }
    .grid { display: grid; grid-template-columns: 1.1fr .9fr; gap: 18px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: var(--pb-card); border: 1px solid var(--pb-border); border-radius: var(--radius);
      padding: 16px 16px 18px; box-shadow: var(--shadow);
    }
    .card h3 { margin: 0 0 12px; color: var(--pb-mid); font-size: 16px; text-transform: uppercase; letter-spacing: .6px; }
    #ad-slot {
      display: grid; place-items: center; background: linear-gradient(180deg,#ffffff, #f2f9fc); border: 1px dashed #cfe5ee;
      border-radius: 12px; min-height: 250px;
    }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      background: var(--pb-blue); color: #fff; border: none; border-radius: 10px;
      padding: 10px 12px; font-weight: 600; cursor: pointer;
    }
    .btn.secondary { background: #E6F6FC; color: var(--pb-blue); }
    code, pre, .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .definitions p { margin: .4rem 0 1rem; }
    .metrics-pill {
      display: inline-flex; gap: 8px; align-items: center; padding: 8px 12px;
      border-radius: 999px; border: 1px solid var(--pb-border); background: #fff;
    }
    .pill-blue {
      border-color: #BFE8F5; background: #E6F7FD; color: var(--pb-mid);
    }
    a { color: var(--pb-blue); }
    footer { margin: 24px 0; color: var(--pb-muted); font-size: 13px; }
  </style>
<meta charset="UTF-8" />
  <title>Prebid + Enrichment Lift + Synthetic Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .row { display: grid; grid-template-columns: 340px 1fr; gap: 24px; align-items: start; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
    #ad-slot { width: 300px; height: 250px; border: 1px dashed #aaa; display: grid; place-items: center; background: #f9f9f9; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #888; background: #fff; cursor: pointer; }
    pre { max-height: 300px; overflow: auto; background: #111; color: #0f0; padding: 12px; border-radius: 8px; }
    .muted { color: #666; font-size: 12px; }
  </style>

<style>
  .wrap{max-width:1100px;margin:28px auto;padding:0 20px}
  .news-grid{display:grid;grid-template-columns:minmax(0,1fr) 320px;gap:22px;align-items:start}
  @media (max-width: 980px){ .news-grid{grid-template-columns:1fr} .sidebar{order:-1} }
  .article p{line-height:1.55}
  .code-section pre, pre{max-height:unset;background:#0b1320;color:#b7e3ff;padding:16px;border-radius:12px;overflow:auto}
</style>


  <style>
    .hero{display:grid;grid-template-columns:240px 1fr;gap:18px;align-items:center}
    @media (max-width:900px){ .hero{grid-template-columns:1fr} }
    .hero-media{display:flex;align-items:center;justify-content:center;height:160px;border-radius:12px;background:#ffffff;border:1px solid var(--pb-border);box-shadow:var(--shadow)}
.hero-media img{max-width:100%;max-height:80%;padding:12px}
    .eyebrow{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--pb-muted);margin-bottom:6px}
    .headline{margin:4px 0 6px;color:var(--pb-dark);font-size:28px;line-height:1.2}
    .byline{color:var(--pb-muted);font-size:13px;margin-bottom:8px}
    .dek{margin:0;color:var(--pb-mid)}
    .figure{margin:0 0 14px;padding:0;overflow:hidden}
    .figure-img{width:100%;height:180px;background:repeating-linear-gradient(45deg,#e9f6fb,#e9f6fb 10px,#d5eef7 10px,#d5eef7 20px)}
    .figure figcaption{padding:8px 10px}
  </style>


  <style>
    .chart-card canvas{display:block}
  </style>

</head>
<body>
  <div class="topbar">
    <div class="brand"><i class="dot"></i><span>Prebid Demo</span></div>
  <div class="wrap">
    
  <div class="hero card">
    <div class="hero-media"><img src="/assets/logo.png" alt="Prebid.org logo"></div>
    <div class="hero-body">
      <div class="eyebrow">PREBID FIELD TEST</div>
      <h1 class="headline">Measuring Identity Lift with SharedID</h1>
      <div class="byline">By <span class="author">Demo Reporter</span> • Oct 6, 2025</div>
      <p class="dek">A lightweight, news‑style demo showing how a publisher page runs a Prebid auction and how SharedID impacts yield—complete with a standard 300×250 ad slot.</p>
    </div>
  </div>


    <div class="news-grid">
      
<main class="article card">
  
    <section class="card chart-card">
      <div class="chart-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <h3 style="margin:0 0 4px">Figure 1 — Realtime Bid CPM by Cohort</h3>
          <div class="muted">Updates on auction click · test vs control</div>
        </div>
        <div class="chart-legend" style="display:flex;gap:14px;align-items:center">
          <span style="display:inline-flex;align-items:center;gap:8px"><i class="dot" style="width:10px;height:10px;border-radius:50%;background:#00A2E1;display:inline-block"></i>Test</span>
          <span style="display:inline-flex;align-items:center;gap:8px"><i class="dot" style="width:10px;height:10px;border-radius:50%;background:#FF8A00;display:inline-block"></i>Control</span>
        </div>
      </div>
      <div style="position:relative;margin-top:10px">
        <canvas id="metricsChart" style="width:100%;height:260px;border-radius:12px;background:#ffffff;border:1px solid var(--pb-border)"></canvas>
        <div id="chartStatus" class="muted" style="position:absolute;left:12px;top:12px">waiting for data…</div>
      </div>
    </section>
    
  <p>In this demo, we randomize whether SharedID is present (“test”) or suppressed (“control”) and observe the effect on the winning CPM. The right rail mimics a typical news site ad position using a 300×250 slot.</p>
  <p>Below, we also include the exact <code>pbjs.setConfig</code> used on the page to make it easy to copy during a live talk. Try toggling <code>synthLift</code> in the URL to simulate different outcomes.</p>

  <h2 style="margin-top:0">What we&rsquo;re measuring</h2>
  <p><strong>Test (treatment)</strong> → the SharedID module is allowed/kept. You’ll typically see an EID for it (in your build it shows up under pubcid.org because SharedID is aliased to PubCommonId).</p>
  <p><strong>Control</strong> → the SharedID is suppressed/stripped (because you set <code>suppression: 'eids'</code>), so it won’t be sent along with the auction.</p>
  <p><strong>avgTreatment</strong> The average treatment CPM in that cohort = (sum of <code>treatmentCpm</code>) / auctions. In your page, this is the CPM of the ad that actually “won” (synthetic when <code>synthWinRate=1</code>, otherwise the winning path). Units: USD CPM.</p>
  <p><strong>incrementalLiftAbs</strong> The global absolute lift per auction attributable to the test cohort: <code>incrementalLiftAbs = test.avgTreatment − control.avgTreatment</code>. Positive = test (e.g., SharedID present) is earning more per auction. Units: USD CPM.</p>
  <p><strong>incrementalLiftPct</strong> The global relative lift: <code>incrementalLiftPct = incrementalLiftAbs / control.avgTreatment</code> (null if control.avgTreatment = 0). This is a fraction (e.g., 0.25 = +25%).</p>
</main>

      
<aside class="sidebar">
  <div class="card" style="position:sticky; top:86px">
    <div id="ad-slot" style="width:300px; height:250px; margin:0 auto 12px; display:grid; place-items:center; border:1px dashed #cfe5ee; border-radius:12px; background:linear-gradient(180deg,#ffffff,#f2f9fc)">Ad will render here</div>
    <div class="controls" style="justify-content:center">
      <button class="btn" id="rerun">Re-run Auction</button>
    </div>
    <div class="muted" style="margin-top:10px; text-align:center">URL params: <code>?pbjs_debug=true&amp;ga=http://enrichment-lift:9090/collect</code></div>
  </div>
</aside>

      
<section class="card" style="grid-column:1 / -1">
  <h3>Prebid setConfig</h3>
  <pre><code class="language-js">pbjs.setConfig({
  bidderTimeout: 1200,
  userSync: {
    syncDelay: 0,
    userIds: [{
      name: 'sharedId',
      storage: { type: 'cookie', name: '_sharedid', expires: 365 }
    }]
  },
  enrichmentLiftMeasurement: {
    testRun: 'SharedId test',
    storeSplits: 'memory',
    suppression: 'eids',
    modules: [
      { name: 'sharedId', percentage: 0.5}
    ]
  }
});</code></pre>
</section>

    </div>
  </div>

  <!-- scripts -->
  <script src="prebid.js" async></script>
  <script src="vendors/enrichmentLabels.js"></script>
  <script src="vendors/patchGenericLabels.js"></script>

  <script>
  // ---------- Helpers ----------
  const params = new URLSearchParams(location.search);
  const collectUrl = params.get('ga') || params.get('analytics') || 'http://enrichment-lift:9090/collect';
  const synthWinRate = Math.min(1, Math.max(0, parseFloat(params.get('synthWinRate') || '1'))); // 0..1
  const logEl = document.getElementById('log');
  function currentCohort(runKey = 'SharedId test', submodule = 'sharedId') {
    const L = (typeof __computeEnrichmentLabels === 'function') ? __computeEnrichmentLabels() : {};
    const arr = Array.isArray(L[runKey]) ? L[runKey] : [];
    const rec = arr.find(o => o && (o.name === submodule || o.name === submodule + 'System'));
    return (rec && typeof rec.enabled === 'boolean') ? (rec.enabled ? 'test' : 'control') : 'unknown';
  }


  function logLine(obj) {
    if (!logEl) return;
    logEl.textContent += JSON.stringify(obj) + "\n";
    logEl.scrollTop = logEl.scrollHeight;
    console.info(obj);
  }

  // Custom event POSTer ONLY for synthetic/render helpers
  function postCustom(event, payload) {
    const line = { ts: new Date().toISOString(), event, payload };
    logLine(line);
    // Send ONLY these custom events to the collector
    try {
      const json = JSON.stringify(line);
      const cross = new URL(collectUrl, location.href).origin !== location.origin;
      if (!cross && navigator.sendBeacon) {
        navigator.sendBeacon(collectUrl, json);
      } else {
        fetch(collectUrl, { method: 'POST', mode: 'cors', credentials: 'omit', body: json });
      }
    } catch (e) {
      console.warn('custom post failed', e);
    }
  }

  // ---------- Prebid setup ----------
  window.pbjs = window.pbjs || {}; pbjs.que = pbjs.que || [];

  pbjs.que.push(function () {
    //Below is a surgical patch for your index.html. It emits a type: "lift_auction" record after you pick/render the winner, with fields your server already aggregates (baselineCpm, treatmentCpm, incrementalCpm, cohort, plus labels).

    // ---- LIFT SUMMARY HELPERS ----
    function round2(x){ return Math.round((Number(x) + Number.EPSILON) * 100) / 100; }
    function getLabels(){ return (window.pbjs && window.pbjs._analyticsLabels) || {}; }

    function postSummary(baselineCpm, treatmentCpm, winnerSource) {
      const labels = (typeof __computeEnrichmentLabels === 'function') ? __computeEnrichmentLabels() : getLabels();
      const cohort = currentCohort('SharedId test', 'sharedId') || window.__lastAuctionCohort || 'unknown';
      const payload = {
        type: 'lift_auction',
        cohort,
        baselineCpm: round2(baselineCpm),
        treatmentCpm: round2(treatmentCpm),
        incrementalCpm: round2(Number(treatmentCpm) - Number(baselineCpm)),
        winner: winnerSource,
        labels
      };

      // Push a point to the chart (scatter)
      try { window.__chartPushAuction && window.__chartPushAuction({ cohort, treatmentCpm: Number(treatmentCpm) }); } catch(e) {}

      // Update chart on demand (no background polling)
      try { window.__chartRefresh && window.__chartRefresh(); } catch(e) {}

      // Send summary to the collector
      try {
        const json = JSON.stringify(payload);
        const cross = new URL(collectUrl, location.href).origin !== location.origin;
        if (!cross && navigator.sendBeacon) {
          navigator.sendBeacon(collectUrl, json);
        } else {
          fetch(collectUrl, { method: 'POST', mode: 'cors', credentials: 'omit', body: json });
        }
      } catch(e) {
        console.warn('summary send failed', e);
      }
    }

    // Set config: SharedID + Enrichment Lift
    //const treatmentPct = parseFloat(params.get('treatment') || '1.0'); // default 100% treatment
pbjs.setConfig({
      bidderTimeout: 1200,
      userSync: {
        syncDelay: 0,
        userIds: [{
          name: 'sharedId',
          storage: { type: 'cookie', name: '_sharedid', expires: 365 }
        }]
      },
      enrichmentLiftMeasurement: {
        testRun: "SharedId test",
        storeSplits: 'memory',
        suppression: 'submodules',
        modules: [
          { name: 'sharedId', percentage: 0.5 }
        ]
      }
    });

    // Enable built-in Generic Analytics (module is included in your prebid.js build)
    pbjs.enableAnalytics({
      provider: 'generic',
      options: {
        url: collectUrl,
        batchSize: 5,
        batchDelay: 200,
        events: {
          auctionInit(args)   { return { eventType: 'auctionInit',   labels: __computeEnrichmentLabels(), args }; },
          bidRequested(args)  { return { eventType: 'bidRequested',  labels: __computeEnrichmentLabels(), args }; },
          bidResponse(args)   { return { eventType: 'bidResponse',   labels: __computeEnrichmentLabels(), args }; },
          auctionEnd(args)    { return { eventType: 'auctionEnd',    labels: __computeEnrichmentLabels(), args }; },
          bidWon(args)        { return { eventType: 'bidWon',        labels: __computeEnrichmentLabels(), args }; },
          noBid(args)         { return { eventType: 'noBid',         labels: __computeEnrichmentLabels(), args }; },
          bidTimeout(args)    { return { eventType: 'bidTimeout',    labels: __computeEnrichmentLabels(), args }; }
        }
      }
    });

      // ---- ELM console logger (coin toss + config) ----
      (function () {
        const RUN = 'SharedId test'; // must exactly match testRun
        window.__lastAuctionCohort = 'unknown';

        pbjs.onEvent('auctionEnd', function () {
          const cohort = currentCohort(RUN, 'sharedId');
          window.__lastAuctionCohort = cohort;
          // also log the raw run array so you can see enabled:true/false
          const L = (typeof __computeEnrichmentLabels === 'function') ? __computeEnrichmentLabels() : {};
          console.log('%c[ELM coin toss]', 'background:#00A2E1;color:#fff;padding:2px 6px;border-radius:4px',
            cohort, Array.isArray(L[RUN]) ? L[RUN] : []);
        });
      })();

    // Define one banner unit for demo
    const adUnits = [{
      code: 'hb-direct-slot',
      mediaTypes: { banner: { sizes: [[300, 250]] } },
      bids: [
        // keep a real bidder for signal; replace with your adapter(s) as needed
        { bidder: 'appnexus', params: { placementId: '13144370' } }
      ]
    }];

    // Attach UI
    document.getElementById('rerun').addEventListener('click', () => {
      const url = new URL(location.href);
      const p = url.searchParams;
      let changed = false;
      const setParam = (k, v) => { if (p.get(k) !== v) { p.set(k, v); changed = true; } };
      // enforce demo params
      setParam('pbjs_debug', 'true');
      setParam('analytics', 'http://enrichment-lift:9090/collect');
      setParam('synthWinRate', '1');
      setParam('synthLift', '0.3');

      if (changed) {
        url.search = p.toString();
        location.replace(url.toString()); // reload with enforced params
        return;
      }
      // already correct: run the auction now
      try { runAuction(); } catch (e) { console.warn('runAuction() not ready', e); }
    });

    function renderSynthetic({ cpm, creative }) {
      const slot = document.getElementById('ad-slot');
      const isImg = /\.(png|jpe?g|gif|webp|svg)$/i.test(creative);
      if (isImg) {
        slot.innerHTML = '';
        const img = new Image();
        img.width = 300; img.height = 250;
        img.src = creative;
        slot.appendChild(img);
      } else {
        slot.innerHTML = `<iframe src="${creative}" width="300" height="250" frameborder="0" scrolling="no"></iframe>`;
      }
      postCustom('render_success', { source: 'synthetic', cpm, creative, kind: isImg ? 'image' : 'iframe' });
    }

    function renderPrebid(winning) {
      const iframe = document.createElement('iframe');
      iframe.width = 300; iframe.height = 250; iframe.frameBorder = 0; iframe.scrolling = 'no';
      document.getElementById('ad-slot').innerHTML = '';
      document.getElementById('ad-slot').appendChild(iframe);
      try {
        pbjs.renderAd(iframe.contentDocument, winning.adId);
        postCustom('render_success', { source: 'prebid', cpm: winning.cpm, adId: winning.adId });
      } catch (e) {
        postCustom('render_error', { source: 'prebid', error: String(e) });
      }
    }

    // Synthetic creative rotation (put your files in /ads)
    const creatives = [
      'ads/peanutbutter.jpeg',
      'ads/images.jpeg',
      'ads/download.jpeg'
    ];
    let idx = 0;
    function nextCreative() {
      const c = creatives[idx % creatives.length];
      idx += 1;
      return c;
    }

    function runAuction() {
      // Clear slot
      document.getElementById('ad-slot').innerHTML = 'Loading…';
      postCustom('prebid_init', {});

      pbjs.addAdUnits(adUnits);
      pbjs.requestBids({
        adUnits,
        bidsBackHandler: function () {
          const cohort = currentCohort('SharedId test', 'sharedId');
          // Highest Prebid CPM (if any)
          const top = pbjs.getHighestCpmBids('hb-direct-slot') || [];
          const pb = top[0];
          const pbCpm = pb ? Number(pb.cpm) : 0;

          // Synthetic bid
          const labels = getLabels();
          // base synthetic CPM ~ $1–$3
          let synthCpm = Math.random() * 2 + 1;
          // configurable lift for test cohort (default +$0.50)
          const synthLift = parseFloat((new URLSearchParams(location.search)).get('synthLift') || '0.5');
          if (cohort === 'test') synthCpm += synthLift;
          synthCpm = round2(synthCpm);
          const synthCreative = nextCreative();
          postCustom('synthetic_bid', { cpm: synthCpm, creative: synthCreative });

          // Pick winner: biased by synthWinRate for demo; if no PB, synthetic wins
          let winner;
          const coin = Math.random();
          if (!pb || coin < synthWinRate) {
            winner = { source: 'synthetic', cpm: synthCpm, creative: synthCreative };
            renderSynthetic(winner);
            // Summary: baseline is Prebid CPM, treatment is what we actually delivered (synthetic)
            postSummary(pbCpm, synthCpm, 'synthetic');
          } else {
            winner = { source: 'prebid', cpm: pbCpm, adId: pb.adId };
            renderPrebid(pb);
            // Summary: both baseline and treatment are Prebid CPM (no change)
            postSummary(pbCpm, pbCpm, 'prebid');
          }
        },
        timeout: 800
      });
    }
    const autorun = (new URLSearchParams(location.search)).get('autorun') !== '0';
      if (autorun) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => setTimeout(runAuction, 0));
        } else {
          setTimeout(runAuction, 0);
        }
      }
  }); // <-- closes pbjs.que.push
</script>




<script>
(function(){
  const BLUE = '#00A2E1';      // Prebid blue (test)
  const ORANGE = '#FF8A00';    // accent (control)

  const canvas = document.getElementById('metricsChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  // Per‑auction buffers
  const ptsTest = [];   // {x: ts, y: cpm}
  const ptsCtrl = [];
  const MAX = 400;

  // Push from auction summary
  window.__chartPushAuction = function(ev){
    try {
      const y = Number(ev.treatmentCpm);
      if (!Number.isFinite(y)) return;
      const buf = cohort === 'test' ? ptsTest : ptsCtrl;
      buf.push({ x: Date.now(), y });
      while (buf.length > MAX) buf.shift();
      requestAnimationFrame(draw);
    } catch {}
  };

  // DPR‑aware sizing (no draw call here to avoid recursion)
  function measure(){
    const ratio = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const W = Math.max(300, rect.width);
    const H = Math.max(200, rect.height);
    canvas.width = W * ratio;
    canvas.height = H * ratio;
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    return { W, H };
  }
  window.addEventListener('resize', () => requestAnimationFrame(draw));

  function bounds(){
    const all = ptsTest.concat(ptsCtrl);
    if (!all.length){
      const now = Date.now();
      return { xmin: now-60000, xmax: now, ymin: 0.5, ymax: 3.5 };
    }
    const xs = all.map(p=>p.x), ys = all.map(p=>p.y);
    let xmin = Math.min(...xs), xmax = Math.max(...xs);
    let ymin = Math.min(...ys), ymax = Math.max(...ys);
    const spanX = Math.max(1000, xmax-xmin);
    const spanY = Math.max(0.1, ymax-ymin);
    const padX = spanX * 0.05, padY = spanY * 0.10;
    return { xmin: xmin-padX, xmax: xmax+padX, ymin: Math.max(0, ymin-padY), ymax: ymax+padY };
  }
  const toX = (x,b,W)=> ((x-b.xmin)/(b.xmax-b.xmin||1))*(W-50)+40;
  const toY = (y,b,H)=> H - ((y-b.ymin)/(b.ymax-b.ymin||1))*(H-50) - 30;

  function axes(b, W, H){
    ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='rgba(15,45,58,.10)'; ctx.lineWidth=1;
    for (let i=0;i<4;i++){ const y=30+i*(H-50)/3; ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(W-8,y); ctx.stroke(); }
    ctx.strokeStyle='rgba(15,45,58,.35)';
    ctx.beginPath(); ctx.moveTo(40,20); ctx.lineTo(40,H-20); ctx.lineTo(W-8,H-20); ctx.stroke();
    ctx.fillStyle='rgba(15,45,58,.7)'; ctx.font='12px Inter, system-ui, sans-serif';
    for (let i=0;i<=3;i++){ const v=b.ymin+i*(b.ymax-b.ymin)/3; const y=toY(v,b,H)+4; ctx.fillText(v.toFixed(2), 8, y); }
  }

  function points(arr, color, b, W, H){
    ctx.fillStyle=color;
    for (const p of arr){
      const x=toX(p.x,b,W), y=toY(p.y,b,H);
      ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
    }
  }

  // y = a + b*x fit via least squares
  function regress(arr){
    if (arr.length < 2) return null;
    const n=arr.length;
    const mx = arr.reduce((s,p)=>s+p.x,0)/n;
    const my = arr.reduce((s,p)=>s+p.y,0)/n;
    let num=0, den=0;
    for (const p of arr){ const dx=p.x-mx; num+=dx*(p.y-my); den+=dx*dx; }
    const b = den ? num/den : 0;
    const a = my - b*mx;
    return { a, b };
  }
  function trend(arr, color, b, W, H){
    const fit = regress(arr); if(!fit) return;
    const y1 = fit.a + fit.b*b.xmin, y2 = fit.a + fit.b*b.xmax;
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.globalAlpha=.6;
    ctx.beginPath();
    ctx.moveTo(toX(b.xmin,b,W), toY(y1,b,H));
    ctx.lineTo(toX(b.xmax,b,W), toY(y2,b,H));
    ctx.stroke(); ctx.globalAlpha=1;
  }

  function draw(){
    const { W, H } = measure();
    const b = bounds();
    axes(b, W, H);
    points(ptsCtrl, ORANGE, b, W, H);
    points(ptsTest, BLUE,   b, W, H);
    trend(ptsCtrl, ORANGE, b, W, H);
    trend(ptsTest, BLUE,   b, W, H);
    // last values
    const tLast = ptsTest.length ? ptsTest[ptsTest.length-1].y : null;
    const cLast = ptsCtrl.length ? ptsCtrl[ptsCtrl.length-1].y : null;
    ctx.font='12px Inter, system-ui, sans-serif'; ctx.textAlign='right';
    if (tLast!=null){ ctx.fillStyle=BLUE;   ctx.fillText(tLast.toFixed(2)+' test',    W-12,24); }
    if (cLast!=null){ ctx.fillStyle=ORANGE; ctx.fillText(cLast.toFixed(2)+' control', W-12,40); }
  }

  // initial paint
  draw();
})();
</script>

</body>
</html>